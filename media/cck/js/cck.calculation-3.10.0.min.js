/*
 * jQuery Calculation Plug-in * Copyright (c) 2011 Dan G. Switzer, II Dual licensed under the MIT and GPL licenses: * http://www.opensource.org/licenses/mit-license.php * http://www.gnu.org/licenses/gpl.html
 * Modified for SEBLOD (App Builder & CCK) // SEBLOD nano (Form Builder).
 */
!function($){var defaults={formatNumber:0,sepDecimals:".",sepThousands:",",reChars:/([a-zA-Z0-9\ \-_])*/g,reNumbers:/(-?\$?)(\d+(,\d{3})*(\.\d{1,})?|\.\d{1,})/g,cleanseNumber:function(a){return a.replace(/[^0-9.\-]/g,"")},useFieldPlugin:!!$.fn.getValue,onParseError:null,onParseClear:null};$.Calculation={version:"0.4.09",setDefaults:function(a){$.extend(defaults,a)}},$.fn.parseChar=function(a,b){var c=[];return b=$.extend(b,defaults),this.each(function(d){if(a[d]){var e=$(this);if(e.is("select"))var f=$.trim(e.find("option:selected").attr(a[d])).match(defaults.reChars,"");else if(e.is("fieldset"))var f=$.trim(e.find("input:checked").attr(a[d])).match(defaults.reChars,"");else var f=$.trim(e.attr(a[d])).match(defaults.reChars,"");f=null==f?"":f.toString().replace(",","")}else{var e=$(this),g=e.is(":input")?defaults.useFieldPlugin?"getValue":"val":e.is("fieldset")?"myVal":"text",f=$.trim(e[g]()).match(defaults.reChars,"");null==f?(f="",jQuery.isFunction(b.onParseError)&&b.onParseError.apply(e,[g]),$.data(e[0],"calcParseError",!0)):(f=f[0],$.data(e[0],"calcParseError")&&jQuery.isFunction(b.onParseClear)&&(b.onParseClear.apply(e,[g]),$.data(e[0],"calcParseError",!1)))}c.push(f)}),c},$.fn.parseNumber=function(a,b){var c=[];return b=$.extend(b,defaults),this.each(function(d){if(a[d]){var e=$(this);if(e.is("select"))var f=$.trim(e.find("option:selected").attr(a[d])).match(defaults.reNumbers,"");else if(e.is("fieldset")){var f=0,g=0;e.find("input:checked").each(function(){g=$(this).attr(a[d]),g&&(f+=parseInt(g))}),f=$.trim(f).match(defaults.reNumbers,"")}else var f=$.trim(e.attr(a[d])).match(defaults.reNumbers,"");null==f&&(f=0)}else{var e=$(this);if(e.is("fieldset")){sMethod="myVal";var f=e[sMethod]();if(f){var h=f.split(","),i=h.length;if(i>1){f=0;for(var j=0;j<i;j++)h[j]&&(f+=parseInt(h[j]))}}f=$.trim(f).match(defaults.reNumbers,"")}else if(e.is(":input")){sMethod=defaults.useFieldPlugin?"getValue":"val";var f=$.trim(e[sMethod]()).match(defaults.reNumbers,"")}else{sMethod="text";var f=$.trim(e[sMethod]()).match(defaults.reNumbers,"")}null==f?(f=0,jQuery.isFunction(b.onParseError)&&b.onParseError.apply(e,[sMethod]),$.data(e[0],"calcParseError",!0)):(f=b.cleanseNumber.apply(this,[f[0]]),$.data(e[0],"calcParseError")&&jQuery.isFunction(b.onParseClear)&&(b.onParseClear.apply(e,[sMethod]),$.data(e[0],"calcParseError",!1)))}c.push(parseFloat(f,10))}),c},$.fn.calc=function(expr,vars,targets,cbFormat,cbDone){var $this=this,exprValue="",precision=0,$el,$el2,parsedVars={},tmp,sMethod,target=[],_,bIsError=!1,i=0;for(var k in vars)expr=expr.replace(new RegExp("("+k+")","g"),"_.$1"),vars[k]&&vars[k].jquery?(target[0]=targets[i],parsedVars[k]=vars[k].parseNumber(target)):parsedVars[k]=vars[k],i++;return this.each(function(i,el,el2){var p,len,v;$el=$(this),$el2=$("#_"+$(this).attr("id")),sMethod=$el.is(":input")?defaults.useFieldPlugin?"setValue":"val":$el.is("fieldset")?"myVal":"text",_={};for(var k in parsedVars)"number"==typeof parsedVars[k]?_[k]=parsedVars[k]:"string"==typeof parsedVars[k]?_[k]=parseFloat(parsedVars[k],10):parsedVars[k]&&parsedVars[k]instanceof Array&&(tmp=parsedVars[k].length==$this.length?i:0,_[k]=parsedVars[k][tmp]),isNaN(_[k])&&(_[k]=0),p=_[k].toString().match(/\.\d+$/gi),len=p?p[0].length-1:0,len>precision&&(precision=len);try{if(exprValue=eval(expr),precision&&(exprValue=Number(exprValue.toFixed(Math.max(precision,4)))),jQuery.isFunction(cbFormat)){var tmp=cbFormat.apply(this,[exprValue]);tmp&&(exprValue=tmp)}}catch(a){exprValue=a,bIsError=!0}v=exprValue.toString(),defaults.formatNumber&&(v=formatNumber(v,defaults.sepDecimals,defaults.sepThousands)),$el[sMethod](v),$el2.length&&(sMethod=$el2.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text",$el2[sMethod](v))}),jQuery.isFunction(cbDone)&&cbDone.apply(this,[this]),this},$.each(["sum","product","concatenate","avg","count","max","min"],function(a,b){$.fn[b]=function(a,c,d){var d=d||[];if(0==arguments.length)return math[b](this.parseNumber());var e=c&&c.constructor==Object&&!(c instanceof jQuery),f=a&&a.constructor==Object?a:{bind:a||"keyup",selector:e?null:c,selector2:"",oncalc:null};e&&(f=jQuery.extend(f,c)),f.selector&&(f.selector=$(f.selector)),f.selector2=$("#_"+f.selector.attr("id"));var j,g="concatenate"==b?"parseChar":"parseNumber",i=this,k=function(){var a=math[b](i[g](d,f)),c=a.toString();defaults.formatNumber&&(c=formatNumber(c,defaults.sepDecimals,defaults.sepThousands)),f.selector&&(j=f.selector.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text",f.selector[j](c)),f.selector2.length&&(j=f.selector2.is(":input")?defaults.useFieldPlugin?"setValue":"val":"text",f.selector2[j](c)),jQuery.isFunction(f.oncalc)&&f.oncalc.apply(i,[a,f])};return k(),"none"!=f.bind?i.bind(f.bind,k):void 0}});var math={sum:function(a){var b=0,c=0;return $.each(a,function(a,d){var e=d.toString().match(/\.\d+$/gi),f=e?e[0].length-1:0;f>c&&(c=f),b+=d}),c&&(b=Number(b.toFixed(c))),b},product:function(a){var b=1,c=0;return $.each(a,function(a,d){var e=d.toString().match(/\.\d+$/gi),f=e?e[0].length-1:0;f>c&&(c=f),b*=d}),c&&(b=Number(b.toFixed(c))),b},concatenate:function(a){var b="";return $.each(a,function(a,c){b+=c}),b},avg:function(a){return math.sum(a)/a.length},count:function(a){return a.length},max:function(a){return Math.max.apply(Math,a)},min:function(a){return Math.min.apply(Math,a)}};$.fn.format=function(a,b,c){if(0==arguments.length)return this.val();var d=b&&b.constructor==Object&&!(b instanceof jQuery),e=a&&a.constructor==Object?a:{bind:a||"keyup",selector:d?null:b,selector2:"",oncalc:null};d&&(e=jQuery.extend(e,b)),e.selector&&(e.selector=$(e.selector)),e.selector2=$("#_"+e.selector.attr("id"));var h=this,i=function(){if(""!=defaults.sepThousands)var a=new RegExp("\\"+defaults.sepThousands,"g"),b=e.selector.val().replace(a,"");else var b=e.selector.val();var c=formatNumber(b.toString(),defaults.sepDecimals,defaults.sepThousands);e.selector&&e.selector.val(c),e.selector2.length&&e.selector2.val(c),jQuery.isFunction(e.oncalc)&&e.oncalc.apply(h,[b,e])};return i(),"none"!=e.bind?h.bind(e.bind,i):void 0};var formatNumber=function(a,b,c){if(a+="",x=a.split("."),x1=x[0],x2=x.length>1?b+x[1]:"",""!=c)for(var d=/(\d+)(\d{3})/;d.test(x1);)x1=x1.replace(d,"$1"+c+"$2");return x1+x2}}(jQuery);